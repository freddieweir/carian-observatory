#!/bin/bash
set -e

echo "üìã Validating Carian Observatory Co-located Template System"
echo "========================================================="

ISSUES=0

# Check for co-located .template files
TEMPLATE_COUNT=$(find . -name "*.template" -not -path "./.git/*" 2>/dev/null | wc -l)
echo "üìÅ Found $TEMPLATE_COUNT co-located template files"

# Check for legacy templates/ directory
if [ -d "templates/" ]; then
    LEGACY_COUNT=$(find templates/ -name "*.template" 2>/dev/null | wc -l)
    if [ $LEGACY_COUNT -gt 0 ]; then
        echo "‚ö†Ô∏è Found $LEGACY_COUNT template files in legacy templates/ directory"
        echo "üí° Consider migrating to co-located structure"
    else
        echo "‚ÑπÔ∏è Empty legacy templates/ directory can be removed"
    fi
else
    echo "‚úÖ Using modern co-located template structure"
fi

# Check master script
if [ ! -f "create-all-from-templates.sh" ]; then
    echo "‚ùå Master generation script missing"
    ISSUES=$((ISSUES + 1))
elif [ ! -x "create-all-from-templates.sh" ]; then
    echo "‚ö†Ô∏è Master script not executable"
    chmod +x create-all-from-templates.sh
    echo "‚úÖ Fixed permissions"
else
    echo "‚úÖ Master script ready"
fi

# Validate template files use yourdomain.com
echo "üîç Validating template domains..."
find . -name "*.template" -not -path "./.git/*" | while read -r file; do
    if grep -q "\.com" "$file" && ! grep -q "yourdomain.com" "$file"; then
        echo "‚ö†Ô∏è $file contains domains other than yourdomain.com"
        ISSUES=$((ISSUES + 1))
    fi
done

# Check gitignore compliance
echo "üîç Validating .gitignore compliance..."
if [ -f ".gitignore" ]; then
    if grep -q "scripts/" .gitignore && grep -q "services/\*/configs/" .gitignore; then
        echo "‚úÖ .gitignore properly excludes generated files"
    else
        echo "‚ö†Ô∏è .gitignore may not properly exclude generated files"
        ISSUES=$((ISSUES + 1))
    fi

    if grep -q "!\*\*/\*.template" .gitignore; then
        echo "‚úÖ .gitignore allows .template files"
    else
        echo "‚ö†Ô∏è .gitignore may not allow .template files"
        ISSUES=$((ISSUES + 1))
    fi
else
    echo "‚ùå .gitignore file missing"
    ISSUES=$((ISSUES + 1))
fi

# Check that template files are tracked
echo "üîç Checking template files are tracked by git..."
TRACKED_TEMPLATES=$(git ls-files | grep "\.template$" | wc -l)
echo "üìÇ Found $TRACKED_TEMPLATES tracked .template files"

if [ $TRACKED_TEMPLATES -eq 0 ]; then
    echo "‚ö†Ô∏è No .template files are tracked by git"
    ISSUES=$((ISSUES + 1))
fi

# Check that generated files are not tracked
echo "üîç Checking generated files are not tracked..."
TRACKED_SCRIPTS=$(git ls-files scripts/ | grep -v "\.template$" | grep -v "README.md" | wc -l)
if [ $TRACKED_SCRIPTS -gt 0 ]; then
    echo "‚ö†Ô∏è Found $TRACKED_SCRIPTS tracked non-template files in scripts/"
    git ls-files scripts/ | grep -v "\.template$" | grep -v "README.md" | head -5
    ISSUES=$((ISSUES + 1))
else
    echo "‚úÖ Only .template files tracked in scripts/"
fi

if [ $ISSUES -eq 0 ]; then
    echo "‚úÖ Template system validation passed"
else
    echo "‚ùå Template system has $ISSUES issues"
    exit 1
fi