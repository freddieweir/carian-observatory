name: CI - Build and Test

# Fortify Workflow v1.0.0
# Auto-deployed from Tomb of Nazarick
# Supports: Python, Node.js, Go, Rust

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  detect-language:
    name: Detect Project Language
    runs-on: ubuntu-latest
    outputs:
      is-python: ${{ steps.detect.outputs.is-python }}
      is-nodejs: ${{ steps.detect.outputs.is-nodejs }}
      is-go: ${{ steps.detect.outputs.is-go }}
      is-rust: ${{ steps.detect.outputs.is-rust }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Detect project type
        id: detect
        run: |
          # Detect Python
          if [ -f "pyproject.toml" ] || [ -f "requirements.txt" ] || [ -f "setup.py" ]; then
            echo "is-python=true" >> "$GITHUB_OUTPUT"
          else
            echo "is-python=false" >> "$GITHUB_OUTPUT"
          fi

          # Detect Node.js
          if [ -f "package.json" ]; then
            echo "is-nodejs=true" >> "$GITHUB_OUTPUT"
          else
            echo "is-nodejs=false" >> "$GITHUB_OUTPUT"
          fi

          # Detect Go
          if [ -f "go.mod" ]; then
            echo "is-go=true" >> "$GITHUB_OUTPUT"
          else
            echo "is-go=false" >> "$GITHUB_OUTPUT"
          fi

          # Detect Rust
          if [ -f "Cargo.toml" ]; then
            echo "is-rust=true" >> "$GITHUB_OUTPUT"
          else
            echo "is-rust=false" >> "$GITHUB_OUTPUT"
          fi

  python-ci:
    name: Python CI
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.is-python == 'true'
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Check for uv
        id: check-uv
        run: |
          if [ -f "uv.lock" ]; then
            echo "has-uv=true" >> "$GITHUB_OUTPUT"
          else
            echo "has-uv=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install uv (if using modern Python)
        if: steps.check-uv.outputs.has-uv == 'true'
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies (uv)
        if: steps.check-uv.outputs.has-uv == 'true'
        run: |
          uv sync

      - name: Install dependencies (pip)
        if: steps.check-uv.outputs.has-uv == 'false'
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Run tests (pytest)
        if: hashFiles('**/test_*.py', '**/*_test.py') != ''
        run: |
          if [ "${{ steps.check-uv.outputs.has-uv }}" == "true" ]; then
            uv run pytest -v
          else
            pytest -v || echo "âš ï¸  Tests not found or pytest not installed"
          fi

      - name: Lint with ruff (if available)
        continue-on-error: true
        run: |
          if [ "${{ steps.check-uv.outputs.has-uv }}" == "true" ]; then
            uv run ruff check . || echo "âš ï¸  Ruff not configured"
          elif command -v ruff &> /dev/null; then
            ruff check . || echo "âš ï¸  Ruff not configured"
          fi

  nodejs-ci:
    name: Node.js CI
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.is-nodejs == 'true'
    strategy:
      matrix:
        node-version: ['18.x', '20.x', '22.x']
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        continue-on-error: true
        run: |
          if [ -f "package.json" ] && grep -q "\"lint\"" package.json; then
            npm run lint
          fi

      - name: Run tests
        run: |
          if [ -f "package.json" ] && grep -q "\"test\"" package.json; then
            npm test
          fi

      - name: Build
        continue-on-error: true
        run: |
          if [ -f "package.json" ] && grep -q "\"build\"" package.json; then
            npm run build
          fi

  go-ci:
    name: Go CI
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.is-go == 'true'
    strategy:
      matrix:
        go-version: ['1.21', '1.22', '1.23']
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go ${{ matrix.go-version }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Install dependencies
        run: go mod download

      - name: Run tests
        run: go test -v ./...

      - name: Build
        run: go build -v ./...

      - name: Run go vet
        run: go vet ./...

  rust-ci:
    name: Rust CI
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.is-rust == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Run tests
        run: cargo test --verbose

      - name: Build
        run: cargo build --verbose

      - name: Run clippy
        continue-on-error: true
        run: cargo clippy -- -D warnings

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [detect-language, python-ci, nodejs-ci, go-ci, rust-ci]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ° Fortify CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Detected Languages:**" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-language.outputs.is-python }}" == "true" ]; then
            echo "- ðŸ Python: ${{ needs.python-ci.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.detect-language.outputs.is-nodejs }}" == "true" ]; then
            echo "- ðŸ“¦ Node.js: ${{ needs.nodejs-ci.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.detect-language.outputs.is-go }}" == "true" ]; then
            echo "- ðŸ”µ Go: ${{ needs.go-ci.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.detect-language.outputs.is-rust }}" == "true" ]; then
            echo "- ðŸ¦€ Rust: ${{ needs.rust-ci.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… CI workflow complete!" >> $GITHUB_STEP_SUMMARY