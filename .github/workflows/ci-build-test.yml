name: CI - Infrastructure Validation

# Infrastructure-focused CI workflow
# Validates Docker Compose configs, shell scripts, and YAML files

on:
  push:
    branches: [ main, master, develop, 'claude/**' ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  docker-compose-validation:
    name: Validate Docker Compose
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate main docker-compose.yml
        run: |
          docker compose -f docker-compose.yml config > /dev/null
          echo "âœ… Main docker-compose.yml is valid"

      - name: Validate service-specific compose files
        run: |
          for compose_file in services/*/docker-compose*.yml; do
            if [ -f "$compose_file" ]; then
              echo "Validating $compose_file..."
              # Create temporary .env for validation
              export USER_PREFIX=co
              export COMPOSE_PROJECT_NAME=carian-observatory
              export AUTHELIA_SESSION_SECRET=test_secret_32_chars_minimum_len
              export AUTHELIA_STORAGE_ENCRYPTION_KEY=test_key_32_chars_minimum_length
              export PRIMARY_DOMAIN=example.com
              export WEBUI_DOMAIN=chat.example.com
              export PERPLEXICA_DOMAIN=search.example.com
              export AUTH_DOMAIN=auth.example.com

              docker compose -f "$compose_file" config > /dev/null && echo "âœ… $compose_file valid" || echo "âŒ $compose_file invalid"
            fi
          done

  shellcheck:
    name: Shell Script Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run ShellCheck on all shell scripts
        run: |
          echo "## ðŸš ShellCheck Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find all .sh files (excluding templates initially)
          shell_files=$(find . -name "*.sh" -not -path "*/\.*" -type f)

          if [ -z "$shell_files" ]; then
            echo "âš ï¸  No shell scripts found to lint" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          error_count=0
          for script in $shell_files; do
            echo "Checking $script..."
            if shellcheck -x "$script"; then
              echo "- âœ… $script" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âŒ $script" >> $GITHUB_STEP_SUMMARY
              error_count=$((error_count + 1))
            fi
          done

          if [ $error_count -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**âŒ $error_count script(s) failed ShellCheck**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**âœ… All shell scripts passed ShellCheck**" >> $GITHUB_STEP_SUMMARY
          fi

  yaml-validation:
    name: YAML Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yamllint
        run: |
          sudo apt-get update
          sudo apt-get install -y yamllint

      - name: Create yamllint config
        run: |
          cat > .yamllint.yml << 'EOF'
          extends: default
          rules:
            line-length:
              max: 120
              level: warning
            indentation:
              spaces: 2
            comments:
              min-spaces-from-content: 1
            document-start: disable
            truthy:
              allowed-values: ['true', 'false', 'on', 'off']
          EOF

      - name: Run yamllint
        run: |
          echo "## ðŸ“ YAML Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find all YAML files (excluding generated ones)
          yaml_files=$(find . \( -name "*.yml" -o -name "*.yaml" \) \
            -not -path "*/\.*" \
            -not -path "*/node_modules/*" \
            -type f)

          if [ -z "$yaml_files" ]; then
            echo "âš ï¸  No YAML files found" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          yamllint -c .yamllint.yml . || true

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**âœ… YAML validation complete**" >> $GITHUB_STEP_SUMMARY

  template-generation-test:
    name: Template Generation Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create test .env file
        run: |
          cat > .env << 'EOF'
          # Test environment for CI
          PRIMARY_DOMAIN=test.example.com
          WEBUI_DOMAIN=chat.test.example.com
          PERPLEXICA_DOMAIN=search.test.example.com
          AUTH_DOMAIN=auth.test.example.com
          CANARY_DOMAIN=canary.test.example.com

          USER_PREFIX=co
          COMPOSE_PROJECT_NAME=carian-observatory

          AUTHELIA_SESSION_SECRET=test_session_secret_32_characters_min
          AUTHELIA_STORAGE_ENCRYPTION_KEY=test_storage_key_32_characters_minimum
          EOF

      - name: Test template generation script
        run: |
          if [ -f "scripts/create-all-from-templates.sh" ]; then
            # Make script executable
            chmod +x scripts/create-all-from-templates.sh

            # Dry-run test (if script supports it)
            echo "Testing template generation script..."
            bash scripts/create-all-from-templates.sh || echo "âš ï¸  Template generation needs review"

            echo "âœ… Template generation script executed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Template generation script not found" >> $GITHUB_STEP_SUMMARY
          fi

  security-checks:
    name: Security Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets in non-template files
        run: |
          echo "## ðŸ”’ Security Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for common secret patterns (excluding .env.example and templates)
          if grep -r -E "(password|secret|token|api[_-]?key)" \
            --include="*.yml" \
            --include="*.yaml" \
            --exclude="*.template" \
            --exclude=".env.example" \
            --exclude-dir=".git" \
            . 2>/dev/null; then
            echo "âš ï¸  Found potential secrets in committed files" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No obvious secrets found in committed files" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Verify gitignore coverage
        run: |
          # Check that generated files are properly gitignored
          critical_patterns=(
            ".env"
            "*.key"
            "*.pem"
            "users_database.yml"
          )

          missing_patterns=()
          for pattern in "${critical_patterns[@]}"; do
            if ! grep -q "$pattern" .gitignore; then
              missing_patterns+=("$pattern")
            fi
          done

          if [ ${#missing_patterns[@]} -gt 0 ]; then
            echo "âš ï¸  Missing gitignore patterns: ${missing_patterns[*]}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Critical patterns are gitignored" >> $GITHUB_STEP_SUMMARY
          fi

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [docker-compose-validation, shellcheck, yaml-validation, template-generation-test, security-checks]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ—ï¸ Infrastructure CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Validation Results:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ³ Docker Compose: ${{ needs.docker-compose-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš ShellCheck: ${{ needs.shellcheck.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ YAML: ${{ needs.yaml-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ Templates: ${{ needs.template-generation-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ Security: ${{ needs.security-checks.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Determine overall status
          if [ "${{ needs.docker-compose-validation.result }}" == "success" ] && \
             [ "${{ needs.shellcheck.result }}" == "success" ]; then
            echo "âœ… **All critical checks passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some checks failed - review required**" >> $GITHUB_STEP_SUMMARY
          fi
