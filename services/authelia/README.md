# Authelia Authentication Service

Centralized authentication service providing WebAuthn/FIDO2 and TOTP 2FA for all Carian Observatory services.

## Features

- **WebAuthn/FIDO2**: Hardware security key support (YubiKey, platform authenticators)
- **TOTP 2FA**: Time-based one-time passwords as backup authentication
- **Session Management**: Redis-backed session storage with configurable expiry
- **Access Control**: Policy-based access control for all protected services
- **Brute Force Protection**: Rate limiting and IP banning

## Architecture

```
┌─────────────────┐
│  Nginx Proxy    │
│  (auth_request) │
└────────┬────────┘
         │
         v
┌─────────────────┐      ┌─────────────┐
│    Authelia     │◄────►│   Redis     │
│   (Auth Portal) │      │  (Sessions) │
└─────────────────┘      └─────────────┘
```

## Configuration Files

### Generated from Templates

These files are generated by `/scripts/create-all-from-templates.sh` and should NOT be committed:

- `docker-compose.yml` - Service definition
- `configs/configuration.yml` - Main Authelia configuration
- `data/` - Runtime data (SQLite database, notifications)

### Templates (Committed)

- `docker-compose.yml.template` - Service template
- `configs/configuration.yml.template` - Configuration template

## Environment Variables

Required in `.env`:

```bash
# Authelia Ports
AUTHELIA_PORT=9091
CANARY_AUTHELIA_PORT=9092

# Security Keys (Generate with: openssl rand -hex 32)
AUTHELIA_SESSION_SECRET=your_32_char_random_string
AUTHELIA_STORAGE_ENCRYPTION_KEY=your_32_char_random_string

# Domain Configuration
PRIMARY_DOMAIN=yourdomain.com
AUTH_DOMAIN=auth.yourdomain.com
WEBUI_DOMAIN=chat.yourdomain.com
PERPLEXICA_DOMAIN=search.yourdomain.com
```

## Service Access

- **Production**: https://auth.yourdomain.com
- **Port**: 9091 (production), 9092 (canary)
- **Health Check**: `http://localhost:9091/api/health`

## Initial Setup

1. Generate the configuration from templates:
   ```bash
   /scripts/create-all-from-templates.sh
   ```

2. Create user database (first time only):
   ```bash
   docker exec -it co-authelia-service authelia crypto hash generate argon2
   ```

3. Add user to `configs/users_database.yml`:
   ```yaml
   users:
     your_username:
       displayname: "Your Display Name"
       password: "$argon2id$v=19$m=65536$..."  # Hash from step 2
       email: your.email@example.com
       groups:
         - admins
   ```

4. Restart Authelia:
   ```bash
   docker restart co-authelia-service
   ```

## 2FA Enrollment

After first login:

1. **TOTP Setup** (Recommended as backup):
   - Click profile icon → Two-Factor Authentication
   - Scan QR code with authenticator app (Authy, Google Authenticator, etc.)
   - Save recovery codes securely

2. **WebAuthn Setup** (Primary):
   - Click profile icon → Register Security Key
   - Insert YubiKey or use platform authenticator
   - Follow browser prompts

## Access Control Rules

Default policy: **deny** (all requests blocked unless explicitly allowed)

Protected services require two-factor authentication:
- Open-WebUI (chat.yourdomain.com)
- Perplexica (search.yourdomain.com)
- Homepage dashboard
- Monitoring stack

Edit `configs/configuration.yml` to modify access policies.

## Session Configuration

- **Expiration**: 1 hour (active session)
- **Inactivity**: 5 minutes (auto-logout)
- **Remember Me**: 1 month (persistent cookie)
- **Storage**: Redis (in-memory, shared across services)

## Brute Force Protection

- **Max Retries**: 3 attempts
- **Find Time**: 2 minutes (detection window)
- **Ban Time**: 5 minutes (temporary block)

## Monitoring

### Health Checks

```bash
# Check service health
docker exec co-authelia-service wget -q -O- http://localhost:9091/api/health

# View logs
docker logs co-authelia-service

# Check Redis connection
docker exec co-authelia-redis redis-cli ping
```

### Prometheus Metrics

Authelia exposes metrics on `/api/metrics` (commented out by default).

To enable, uncomment in `monitoring/prometheus/prometheus.yml`:
```yaml
- job_name: 'authelia'
  static_configs:
    - targets: ['co-authelia-service:9091']
```

### Redis Monitoring

Redis metrics are collected by redis-exporter (job: `redis-authelia`).

Alerts configured:
- `AutheliaRedisDown` - Redis unavailable
- High memory usage warnings

## Common Issues

### 403 Forbidden After Login

**Cause**: Service not in Authelia access control rules

**Fix**: Add service domain to `configs/configuration.yml`:
```yaml
access_control:
  rules:
    - domain: 'newservice.yourdomain.com'
      policy: 'two_factor'
```

Then restart: `docker restart co-authelia-service co-nginx-service`

### Session Expires Too Quickly

**Cause**: Short inactivity timeout

**Fix**: Increase `session.cookies.inactivity` in `configs/configuration.yml.template`:
```yaml
session:
  cookies:
    - inactivity: '30m'  # Change from 5m to 30m
```

Regenerate config and restart.

### Can't Register WebAuthn Device

**Cause**: HTTPS required for WebAuthn, domain mismatch

**Fix**:
1. Ensure accessing via HTTPS (WebAuthn requires secure context)
2. Verify `webauthn.display_name` matches your domain
3. Check browser console for specific errors

### Lost All 2FA Devices

**Recovery Options**:

1. **If you have access to the host**:
   ```bash
   # Temporarily disable 2FA in configuration
   docker exec -it co-authelia-service vi /config/configuration.yml
   # Set webauthn.disable: true and totp.disable: true
   docker restart co-authelia-service
   ```

2. **Reset user password**:
   ```bash
   docker exec -it co-authelia-service authelia crypto hash generate argon2
   # Update users_database.yml with new hash
   ```

## Data Persistence

### Backup Locations

- **User Database**: `services/authelia/configs/users_database.yml`
- **SQLite Database**: `services/authelia/data/db.sqlite3` (sessions, U2F registrations)
- **Redis Data**: Ephemeral (sessions only)

### Backup Command

```bash
# Backup entire authelia directory
tar -czf authelia-backup-$(date +%Y%m%d).tar.gz \
  services/authelia/configs \
  services/authelia/data
```

### Restore Command

```bash
# Stop services
docker stop co-authelia-service co-authelia-redis

# Restore from backup
tar -xzf authelia-backup-20251109.tar.gz

# Start services
docker start co-authelia-redis co-authelia-service
```

## Security Considerations

- Store `AUTHELIA_SESSION_SECRET` and `AUTHELIA_STORAGE_ENCRYPTION_KEY` in 1Password
- Rotate secrets regularly (requires user re-authentication)
- Keep user database backups offline
- Review access logs periodically
- Enable Prometheus metrics for monitoring authentication attempts
- Use WebAuthn as primary 2FA (phishing-resistant)

## Resources

- [Authelia Documentation](https://www.authelia.com/docs/)
- [WebAuthn Guide](https://www.authelia.com/docs/configuration/identity-providers/webauthn/)
- [Access Control Configuration](https://www.authelia.com/docs/configuration/access-control/)
- [Troubleshooting Guide](https://www.authelia.com/docs/troubleshooting/)

## Service Dependencies

- **Depends On**: Redis (session storage)
- **Required By**: Nginx (auth_request directive)
- **Network**: app-network (shared with all protected services)
