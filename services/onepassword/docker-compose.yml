# 1Password Connect Server Configuration
# Self-hosted secrets management for Carian Observatory infrastructure
#
# This compose file deploys both Connect Server components:
# - connect-sync: Keeps secrets in sync with 1Password.com
# - connect-api: Provides REST API access to secrets
#
# Requirements:
# - 1password-credentials.json file (generated via: op connect server create)
# - Access tokens for API authentication (generated separately)

services:
  onepassword-connect-sync:
    image: 1password/connect-sync:latest
    container_name: ${USER_PREFIX:-co}-1p-connect-sync
    restart: unless-stopped
    volumes:
      # Mount credentials file for Connect Server authentication
      - ./1password-credentials.json:/home/opuser/.op/1password-credentials.json:ro
      # Shared volume for encrypted data cache between sync and API containers
      - onepassword-data:/home/opuser/.op/data
    environment:
      # Debug logging to troubleshoot bootstrap issues
      OP_LOG_LEVEL: DEBUG
      # Health check configuration
      OP_HTTP_PORT: 8081
    networks:
      - onepassword-internal
      - onepassword-external  # Needs internet to sync with 1Password.com
    # Health check disabled - container is minimal and lacks curl/pgrep
    # Rely on restart policy and API container's start_period instead
    labels:
      - "com.carian-observatory.service=onepassword-connect-sync"
      - "com.carian-observatory.description=1Password Connect Server - Sync Component"
      - "glance.name=1Password Sync"
      - "glance.icon=si:1password"
      - "glance.category=core"
      - "glance.description=Secret sync with 1Password.com"

  onepassword-connect-api:
    image: 1password/connect-api:latest
    container_name: ${USER_PREFIX:-co}-1p-connect-api
    restart: unless-stopped
    depends_on:
      - onepassword-connect-sync
    volumes:
      # Mount credentials file for token validation
      - ./1password-credentials.json:/home/opuser/.op/1password-credentials.json:ro
      # Shared volume with sync container for accessing cached secrets
      - onepassword-data:/home/opuser/.op/data:ro
    environment:
      # API server configuration
      OP_HTTP_PORT: 8080
      OP_LOG_LEVEL: INFO
      # Security: Require token authentication for all requests
      OP_API_HTTP_ENABLED: "true"
    networks:
      - onepassword-internal
      - carian-observatory_app-network
    ports:
      # Internal API access for other services
      - "127.0.0.1:8090:8080"
    # Health check disabled - container is minimal and lacks curl/pgrep
    # Rely on restart policy instead
    labels:
      - "com.carian-observatory.service=onepassword-connect-api"
      - "com.carian-observatory.description=1Password Connect Server - API Component"
      - "glance.name=1Password API"
      - "glance.icon=si:1password"
      - "glance.category=core"
      - "glance.description=Secret management REST API"

networks:
  # Internal network for Connect Server components
  onepassword-internal:
    driver: bridge
    internal: true
    labels:
      - "com.carian-observatory.network=onepassword-internal"
      - "com.carian-observatory.description=Isolated network for 1Password Connect components"

  # External network for sync container to reach 1Password.com
  onepassword-external:
    driver: bridge
    labels:
      - "com.carian-observatory.network=onepassword-external"
      - "com.carian-observatory.description=External network for 1Password.com authentication"

  # Connect to main application network for service access
  carian-observatory_app-network:
    external: true

volumes:
  # Encrypted data cache shared between sync and API containers
  onepassword-data:
    driver: local
    labels:
      - "com.carian-observatory.volume=onepassword-data"
      - "com.carian-observatory.description=1Password Connect Server encrypted data cache"

# Security Notes:
# 1. The credentials file is mounted read-only
# 2. API container only has read access to cached data
# 3. Internal network isolates sync operations
# 4. Health checks ensure proper startup sequencing
# 5. Bind to localhost only for API access (127.0.0.1:8090)