#!/usr/bin/env bash
# =============================================================================
# Portfolio Migration Summary Display
# =============================================================================
# Shows a comprehensive summary of the migration tools and process
# =============================================================================

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

show_header() {
    echo -e "${WHITE}"
    cat << 'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    AI INFRASTRUCTURE PORTFOLIO MIGRATION TOOLKIT                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
    echo -e "${NC}"
}

analyze_current_state() {
    echo -e "${CYAN}ğŸ“Š CURRENT PROJECT ANALYSIS${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # Count sensitive files
    local ssl_count=$(find "$PROJECT_ROOT" \( -name "*.crt" -o -name "*.key" -o -name "*.pem" \) \
                                          -not -path "*/backup/*" -not -path "*/.git/*" 2>/dev/null | wc -l)
    local db_count=$(find "$PROJECT_ROOT" -name "*.sqlite*" \
                                         -not -path "*/backup/*" -not -path "*/.git/*" 2>/dev/null | wc -l)
    
    echo "  ğŸ”’ SSL Certificates & Keys: ${YELLOW}$ssl_count files${NC}"
    echo "  ğŸ—„ï¸  Database Files: ${YELLOW}$db_count files${NC}"
    
    if [[ -f "$PROJECT_ROOT/.env" ]]; then
        local secret_count=$(grep -c "SECRET\|KEY.*=" "$PROJECT_ROOT/.env" 2>/dev/null || echo 0)
        echo "  ğŸ” Hard-coded Secrets: ${YELLOW}$secret_count in .env${NC}"
    fi
    
    # Check for personal information
    local personal_files=$(find "$PROJECT_ROOT" -type f \( -name "*.yml" -o -name "*.conf" -o -name "*.md" -o -name "*.sh" \) \
                          -not -path "*/backup/*" -not -path "*/.git/*" \
                          -exec grep -l "yourdomain\|testdomain\|example\|username\|personal" {} \; 2>/dev/null | wc -l)
    echo "  ğŸ‘¤ Files with Personal Info: ${YELLOW}$personal_files files${NC}"
    
    # Check migration state
    if [[ -f "$PROJECT_ROOT/.migration-state" ]]; then
        local completed_steps=$(grep -c ":completed:" "$PROJECT_ROOT/.migration-state" 2>/dev/null || echo 0)
        echo "  ğŸ¯ Migration Progress: ${GREEN}$completed_steps steps completed${NC}"
    else
        echo "  ğŸ¯ Migration Progress: ${YELLOW}Not started${NC}"
    fi
    
    echo
}

show_tools_overview() {
    echo -e "${CYAN}ğŸ› ï¸  AVAILABLE MIGRATION TOOLS${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo
    
    echo -e "${WHITE}1. Initial Setup & Preparation${NC}"
    echo -e "   ${BLUE}./scripts/init-portfolio-migration.sh${NC}"
    echo "   â€¢ Check prerequisites (1Password CLI, Docker, jq)"
    echo "   â€¢ Analyze current project state"
    echo "   â€¢ Show migration plan overview"
    echo "   â€¢ Create migration configuration"
    echo
    
    echo -e "${WHITE}2. Main Migration Orchestrator${NC}"
    echo -e "   ${BLUE}./scripts/portfolio-security-migration.sh [OPTIONS]${NC}"
    echo "   â€¢ Complete 14-step migration process"
    echo "   â€¢ Progress tracking with visual indicators"  
    echo "   â€¢ Resume capability from any step"
    echo "   â€¢ Interactive confirmations for safety"
    echo "   â€¢ Comprehensive logging and verification"
    echo
    echo "   ${GREEN}Common Usage:${NC}"
    echo "   ./scripts/portfolio-security-migration.sh           # Start fresh"
    echo "   ./scripts/portfolio-security-migration.sh --resume  # Resume interrupted"
    echo "   ./scripts/portfolio-security-migration.sh --verify  # Check status"
    echo "   ./scripts/portfolio-security-migration.sh --help    # Show help"
    echo
    
    echo -e "${WHITE}3. 1Password Integration Scripts${NC} ${PURPLE}(Created during migration)${NC}"
    echo -e "   ${BLUE}./scripts/1password-deploy.sh${NC}"
    echo "   â€¢ Deploy secrets from 1Password to filesystem"
    echo "   â€¢ Process configuration templates"
    echo "   â€¢ Retrieve SSL certificates"
    echo
    echo -e "   ${BLUE}./scripts/generate-and-store-certs.sh${NC}"
    echo "   â€¢ Generate new SSL certificates"
    echo "   â€¢ Store certificates in 1Password"
    echo "   â€¢ Clean up local certificate files"
    echo
}

show_migration_workflow() {
    echo -e "${CYAN}ğŸ”„ COMPLETE MIGRATION WORKFLOW${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo
    
    echo -e "${YELLOW}Phase 1: Preparation${NC}"
    echo "  1ï¸âƒ£  Run initial setup and check prerequisites"
    echo "  2ï¸âƒ£  Create full project backup"  
    echo "  3ï¸âƒ£  Inventory all sensitive files and secrets"
    echo
    
    echo -e "${YELLOW}Phase 2: 1Password Integration${NC}"
    echo "  4ï¸âƒ£  Setup 1Password vault structure"
    echo "  5ï¸âƒ£  Store SSL certificates (66+ files) in 1Password"
    echo "  6ï¸âƒ£  Store configuration secrets and keys"
    echo "  7ï¸âƒ£  Store user databases and authentication data"
    echo "  8ï¸âƒ£  Verify all data is accessible from 1Password"
    echo
    
    echo -e "${YELLOW}Phase 3: Configuration Transformation${NC}"  
    echo "  9ï¸âƒ£  Create secure templates with op:// references"
    echo "  ğŸ”Ÿ Remove personal information, use placeholders"
    echo "  1ï¸âƒ£1ï¸âƒ£ Update scripts for 1Password deployment"
    echo
    
    echo -e "${YELLOW}Phase 4: Cleanup & Portfolio Preparation${NC}"
    echo "  1ï¸âƒ£2ï¸âƒ£ Remove sensitive files from filesystem"
    echo "  1ï¸âƒ£3ï¸âƒ£ Create professional documentation"
    echo "  1ï¸âƒ£4ï¸âƒ£ Final security verification"
    echo
}

show_security_transformation() {
    echo -e "${CYAN}ğŸ” SECURITY TRANSFORMATION OVERVIEW${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo
    
    echo -e "${RED}âŒ BEFORE MIGRATION (Current Issues):${NC}"
    echo "   â€¢ Hard-coded secrets in .env files"
    echo "   â€¢ Personal domains and usernames exposed"
    echo "   â€¢ SSL certificates committed to git"
    echo "   â€¢ User databases with real credentials"
    echo "   â€¢ 66+ sensitive files in version control"
    echo
    
    echo -e "${GREEN}âœ… AFTER MIGRATION (Portfolio-Ready):${NC}"
    echo "   â€¢ All secrets managed via 1Password CLI"
    echo "   â€¢ Generic placeholder domains (yourdomain.com)"
    echo "   â€¢ SSL certificates stored securely in 1Password"
    echo "   â€¢ Configuration templates with op:// references"
    echo "   â€¢ Zero sensitive data in git history"
    echo "   â€¢ Enterprise-grade security documentation"
    echo
}

show_post_migration_workflow() {
    echo -e "${CYAN}ğŸš€ POST-MIGRATION DEPLOYMENT WORKFLOW${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo
    
    echo -e "${WHITE}Your new deployment workflow:${NC}"
    echo "  1. Clone portfolio repository"
    echo "  2. Sign in to 1Password: ${BLUE}op signin${NC}"
    echo "  3. Deploy secrets: ${BLUE}./scripts/1password-deploy.sh${NC}"
    echo "  4. Start services: ${BLUE}docker compose up -d${NC}"
    echo
    
    echo -e "${WHITE}Making configuration changes:${NC}"
    echo "  1. Edit templates: ${BLUE}.env.template, *.yml.template${NC}"
    echo "  2. Deploy changes: ${BLUE}op inject -i .env.template -o .env${NC}"
    echo "  3. Restart services: ${BLUE}docker compose restart${NC}"
    echo
}

show_documentation() {
    echo -e "${CYAN}ğŸ“š DOCUMENTATION & RESOURCES${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo
    
    echo -e "${WHITE}Available Documentation:${NC}"
    if [[ -f "$PROJECT_ROOT/PORTFOLIO_MIGRATION_GUIDE.md" ]]; then
        echo "  ğŸ“– ${GREEN}PORTFOLIO_MIGRATION_GUIDE.md${NC} - Complete migration guide"
    else
        echo "  ğŸ“– ${YELLOW}PORTFOLIO_MIGRATION_GUIDE.md${NC} - (Will be created)"
    fi
    
    if [[ -f "$PROJECT_ROOT/.gitignore.portfolio" ]]; then
        echo "  ğŸ›¡ï¸  ${GREEN}.gitignore.portfolio${NC} - Enhanced security patterns"
    else
        echo "  ğŸ›¡ï¸  ${YELLOW}.gitignore.portfolio${NC} - (Will be created)"
    fi
    
    echo "  ğŸ“‹ ${GREEN}README.md${NC} - Portfolio-ready project documentation"
    echo "  ğŸ” ${GREEN}docs/SECURITY.md${NC} - Security architecture documentation"
    echo "  ğŸš€ ${GREEN}docs/DEPLOYMENT.md${NC} - Production deployment guide"
    echo
}

show_next_steps() {
    echo -e "${CYAN}ğŸ¯ RECOMMENDED NEXT STEPS${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo
    
    if [[ ! -f "$PROJECT_ROOT/.migration-state" ]]; then
        echo -e "${WHITE}First Time Setup:${NC}"
        echo "  1. Run: ${BLUE}./scripts/init-portfolio-migration.sh${NC}"
        echo "  2. Review the migration plan"
        echo "  3. Ensure 1Password CLI is set up"
        echo "  4. Start migration: ${BLUE}./scripts/portfolio-security-migration.sh${NC}"
    else
        local completed_steps=$(grep -c ":completed:" "$PROJECT_ROOT/.migration-state" 2>/dev/null || echo 0)
        if [[ $completed_steps -eq 0 ]]; then
            echo -e "${WHITE}Ready to Start Migration:${NC}"
            echo "  â€¢ Run: ${BLUE}./scripts/portfolio-security-migration.sh${NC}"
        elif [[ $completed_steps -lt 14 ]]; then
            echo -e "${WHITE}Continue Migration:${NC}"
            echo "  â€¢ Resume: ${BLUE}./scripts/portfolio-security-migration.sh --resume${NC}"
            echo "  â€¢ Check status: ${BLUE}./scripts/portfolio-security-migration.sh --verify${NC}"
        else
            echo -e "${WHITE}Migration Complete! ğŸ‰${NC}"
            echo "  â€¢ Verify final state: ${BLUE}./scripts/portfolio-security-migration.sh --verify${NC}"
            echo "  â€¢ Test deployment: ${BLUE}./scripts/1password-deploy.sh${NC}"
            echo "  â€¢ Start services: ${BLUE}docker compose up -d${NC}"
        fi
    fi
    echo
}

show_safety_reminders() {
    echo -e "${CYAN}âš ï¸  IMPORTANT SAFETY REMINDERS${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo
    echo -e "${YELLOW}Before starting:${NC}"
    echo "  â€¢ Ensure 1Password CLI is authenticated"
    echo "  â€¢ Have sufficient disk space for backups"  
    echo "  â€¢ Consider committing current changes to git"
    echo "  â€¢ Review all personal information that will be replaced"
    echo
    echo -e "${YELLOW}During migration:${NC}"
    echo "  â€¢ The process creates full backups before any changes"
    echo "  â€¢ All destructive operations require explicit confirmation"
    echo "  â€¢ You can resume from any step if interrupted"
    echo "  â€¢ Detailed logs are created for every operation"
    echo
    echo -e "${YELLOW}After migration:${NC}"
    echo "  â€¢ Verify all services work with new configuration"
    echo "  â€¢ Test 1Password secret retrieval"
    echo "  â€¢ Review generated documentation"
    echo "  â€¢ Consider replacing .gitignore with .gitignore.portfolio"
    echo
}

main() {
    show_header
    analyze_current_state
    show_tools_overview
    show_migration_workflow  
    show_security_transformation
    show_post_migration_workflow
    show_documentation
    show_next_steps
    show_safety_reminders
    
    echo -e "${GREEN}ğŸ† PORTFOLIO TRANSFORMATION READY${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo
    echo "This toolkit will transform your AI infrastructure project into a professional"
    echo "portfolio piece showcasing enterprise security practices and modern DevSecOps workflows."
    echo
    echo -e "${WHITE}Questions or issues?${NC} Check the ${BLUE}PORTFOLIO_MIGRATION_GUIDE.md${NC} for detailed help."
    echo
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi